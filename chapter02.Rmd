---
title: "Chapter2 潜在的結果変数の枠組み"
author: "Takehito Oshita"
output: 
  slidy_presentation:
    font_adjustment: -1
---

# 2.1 潜在的結果変数の枠組み：具体例

本章で使うデータを読み込んでおきます

```{r データ読み込み, warning=FALSE}
library(tibble)
library(knitr)
library(kableExtra)

url.data.file <- "https://raw.githubusercontent.com/mtakahashi123/causality/main/data02.csv"
D <- read.csv(url(url.data.file))

tabular <- function(df, color=F, title="表"){
    df %>%
    rownames_to_column(var="ID") %>%
    kable(caption=title) %>%
    kable_styling(fixed_thead=T, bootstrap_options=c("striped", "hover", "condensed"))
}

```

```{r 表2.1}
table_2.1 <- function(){
  D0 <- data.frame(D)  # make copy
  D0 <- subset(D0, select=c("x1", "y3", "t1"))
  D0["y3-x1"] <- D0$y3 - D0$x1
  
  tabular(D0, title="表2.1 数学の試験のシミュレーションデータ")
}

table_2.1()
```

数学の入試試験と期末試験の平均値（平均点）をみてみます

```{r 入試試験と期末試験の平均値}
mean(D$x1)  # 入試試験
mean(D$y3)  # 期末試験
mean(D$y3) - mean(D$x1)  # 入学試験と期末試験の平均点の差
```

**よくある間違いとして、この結果を見て、「補習授業は逆効果」と結論づけることは、典型的な誤り**

処置1の学生だけじゃなく、処置0の学生も含まれている点に注目しよう 実際に、処置0 の学生だけに絞ってみても、平均点が下がっている

```{r 処置0の入試試験の平均点と期末試験の平均点}
mean(D$x1[D$t1 == 0])  # 処置0入試試験
mean(D$y3[D$t1 == 0])  # 処置0期末試験
mean(D$y3[D$t1 == 0]) - mean(D$x1[D$t1 == 0])  # 処置0の平均点の差
```

つまり、補習授業の影響と考えるべきではなく、単に期末試験が難しかっただけ、と考えるべきである

次は、補習授業を受けた学生の期末試験の点数の差を見てみます

```{r 処置の違いによる期末試験の平均点の差}
mean(D$y3[D$t1 == 0])  # 処置0期末試験
mean(D$y3[D$t1 == 1])  # 処置1期末試験
mean(D$y3[D$t1 == 1]) - mean(D$y3[D$t1 == 0])  # 処置0と1の平均点の差
```

平均点の差は、補習授業を受けた後の群は、受けていない群に対して約-4点の差である

**よくある間違いのもう一つは、この結果から、「補修授業は逆効果」と結論づけることである**

```{r 表2.2}

table_2.2 <- function(){
  colors_1 <- rep(FALSE, nrow(D))
  colors_1[D$t1==1] <- "#FCFDBFFF"
  colors_0 <- rep(FALSE, nrow(D))
  colors_0[D$t1==0] <- "#FCFDBFFF"
  
  D1 <- data.frame(D)
  D1 <- D1[, colnames(D) != "y3"]
  D1["y1t-y0t"] <- D1$y1t - D1$y0t
  
  
  tabular(D1, title="表2.2 数学の試験（潜在的結果変数の枠組み）") %>%
    column_spec(6, color="black", background=colors_1) %>%
    column_spec(7, color="black", background=colors_0)
}

table_2.2()
```

上記、表2.2 は、潜在的結果変数の枠組みで表現したもの

期末試験0 (y0) と 期末試験1 (y1) とに分割して考える

-   期末試験0 は、補習授業を受けなかった学生の期末試験の実際の点数
-   期末試験1 は、補習授業を受けた学生の期末試験の実際の点数

期末試験0, 1 には、欠損が発生している点に注目（因果推論は、欠測データの問題とも言える）

潜在的結果0 (y0t) と 潜在的結果1 (y1t) は、理論上の変数（神様の立場でのみ具体的な値を知ることができる変数）

-   潜在的結果0 は、すべての学生が補習授業を受けなかった場合の期末試験の点数
-   潜在的結果1 は、すべての学生が補習授業を受けた場合の期末試験の点数
-   ここで、黄色で配色したセルの値は、実際には観測できない「潜在的な」値（y0, y1 が NA）
-   黄色で配色していない値は、実際に観測される値（y0, y1 と一致する）

ここで、潜在的結果0, 1 が両方とも同時に観測できたとして考えてみる

この時、潜在的結果1 から 潜在的結果0 の値を引くことで、補習授業の因果効果を推定できる

この表のケースでは、どの学生に対してもプラスの効果がある、と言える

**実際には、潜在的結果は観測されない！** 統計的因果推論では、工夫をこらして、潜在的結果の差から計算される因果効果を推定する！

------------------------------------------------------------------------

# 2.2 潜在的結果変数の枠組み：理論

-   「処置群」(treatment group)：処置を受ける集団
-   「統制群」(control group)：処置を受けない群
-   「割付け」(assignment)：集団を「処置群」と「統制群」に分けること

### 定式化

$$
T_i：i番目の個体が処置に割り付けられたかどうかを表す２値変数とする \\
i.e. ~T_i \in {0, 1} \\
T_i=1 は、「個体iが処置に割り付けられている」\\
T_i=0 は、「個体iが処置に割り付けられていない」\\
T_i=1 になる集団：「処置群」\\
T_i=0 になる集団：「統制群」
$$

言い換えると

-   処置群：補習授業を受けている学生の集団

-   統制群：補習授業を受けていない学生の集団

表2.1 は、入学試験の結果により、補習授業を受けるかどうかの処置(t1)を決定したデータ

(再掲)

```{r}
table_2.1()
```

-   $Y_i(0), Y_i(1)$ ：個体iの潜在的結果変数（観測できるかどうかわからない結果変数）
-   $Y_i(0)$： 処置がない場合の潜在的な結果変数
-   $Y_i(1)$： 処置がある場合の潜在的な結果変数

以下、式で表現

$$
\begin{equation}
Y_i = (1-T_i)Y_i(0) + T_i Y_i(1) =
    \begin{cases}
      Y_i(0) & \text{if $T_i=0$}\\
      Y_i(1) & \text{if $T_i=1$}\\
    \end{cases}
    \tag{2.1}
\end{equation}
$$

（この表現はよく使う）

ここで、括弧() 付きの $Y_i(\cdot)$ と 括弧がついていない$Y_i$ を区別しよう

-   表2.2 の期末試験0 は、$Y_i|T_i=0$
-   表2.2 の期末試験1 は、$Y_i|T_i=1$

ここで、$Y_i|T_i=0$ は、$T_i = 0$ の時の $Y_I$ の値

$$
\begin{equation}
(Y_i|T_i=0) = (1-T_i)Y_i = 
    \begin{cases}
      Y_i(0) & \text{if $T_i=0$}\\
      0 & \text{if $T_i=1$}\\
    \end{cases}
    \tag{2.2}
\end{equation}
$$

$$
\begin{equation}
(Y_i|T_i=1) = T_i Y_i = 
    \begin{cases}
      0 & \text{if $T_i=0$}\\
      Y_i(1) & \text{if $T_i=1$}\\
    \end{cases}
    \tag{2.3}
\end{equation}
$$

```{r}
summary(D)
```

```{r}
D %>% head(10) %>% tabular(title="data02.csv")
```

表2.1の入学試験の点数である x1 は、実は、平均80、標準偏差10 の正規乱数として生成したもの。 （i.e. x1 $\sim N(80, 10)$）

-   変数y0t は、$0.9x_{1i}+\varepsilon_i$ により生成された潜在的結果変数0（$\varepsilon_i \sim N(0, 1)$ ; 誤差項、記号は、$Y_i(0)$）
-   変数y1t は、$10 + 0.9x_{1i}+\varepsilon_i$ により生成された潜在的結果変数1 (記号は、$Y_i(1)$)
-   変数y0：期末試験0
    -   x1 が 80以上の時、y0t として観測される値（80点以上は、補習授業を受けない、ようにしたということ）
-   変数y1：期末試験1
    -   x1 が 80未満の時、y1t として観測される値（80点未満は、補習授業を受ける、ようにしたということ）
-   変数y3
    -   y0 と y1 の観測部分から構成された値

------------------------------------------------------------------------

# 2.3 処置効果1：個体因果効果

-   個体因果効果(ICE: Individual Causal Effect)：$\tau_i := Y_i(1)-Y_i(0)$
-   個体処置効果(ITE: Individual Treatment Effect) とも言われる
-   表2.2 の例でいうと、$Y_i(1)-Y_i(0)$ は、「潜在的結果1 - 潜在的結果0」(y1t - y0t)
-   この個体因果効果（潜在的結果の差）を知ることが、因果推論の究極の目標

(再掲)

```{r}
table_2.2()
```

表2.2 では、潜在的結果0, 1 がすべての個体に対して観測されたことになっているが、 実際には、黄色で配色している値は観測されるが、配色していない値は、観測されない値であることに改めて注意する

各個体に対して、潜在的結果0 の値が観測されているときは、潜在的結果1 の値は観測されない関係にある

同様に、任意の個体に対して、潜在的結果1 の値が観測されているときは、潜在的結果0 の値は観測されない

e.g. 学生Aに補習授業を受けさせつつ、学生Aに補習授業を受けさせないようにして期末試験をすることは不可能

言い換えると、個体処置効果(ITE) は、概念的に定義できても、観測されない（計算できない）ということである

表2.2 の例でいうと、真の個体因果効果$\tau_i$ は、y1t - y0t で得られるが、実データ解析では計算できない

```{r 真の個体因果効果}
attach(D)
tau <- y1t - y0t
tau
```

入学試験x1 と 期末試験y3 による前後比較 y3 - x1 をみてみる

```{r}
y3 - x1
```

ほとんどが、マイナスになっていて、真の個体因果効果tau とは、大きく異なり、この結果からも前後比較により因果効果を推定してはいけないとわかる

また、期末試験1 - 期末試験0 による処置群と統制群の差 y1 - y0 をみてみる

```{r}
y1 - y0
```

各個体に対して、かならず、どちらかの変数の値が NA (Not Available) であるため、差がすべて NA になる

------------------------------------------------------------------------

# 2.4 処置効果2：平均処置効果

-   個体処置効果(ITE)は、定義できるが観測・計算できない
-   そこで、個体の集まりである母集団の平均因果効果(ACE: Average Causal Effect) というものを考える
-   平均因果効果(ACE) は、期待値(expectation) として定義される

### (前提の確認)期待値とは

-   $E[X]$ : 確率変数$X$ の期待値

-   $X$ が離散型の確率変数の場合、$E[X] := \sum_{i} x_i Pr(x_i)$

-   $X$ が連続型の確率変数($f(x)$ : $X$ の確率密度関数)の場合、$E[X] := \int_{i} x f(x)dx$

-   例

    -   1000枚の宝くじが1枚200円で販売
    -   外れると、10円が返金、当たると500円が返金される時の期待値
    -   外れ：900枚、当たり：100枚
    -   添字0：外れ、添字1：当たり
    -   i.e. $x_0 = 10$、$x_1 = 500$
        -   $Pr(x_0) = 900/1000$、$Pr(x_1) = 100/1000$
    -   期待値$E[X]$ は
        -   $E[X] = \sum_{i=0}^1 x_i Pr(x_i)= x_0 Pr(x_0) + x_1 Pr(x_1) = 10 \times 900/1000 + 500 \times 100/1000 = 59 円$

```{r 期待値E[X]を実際に計算}
10 * 900/1000 + 500*100/1000
```

期待値は、当たり、外れの金額($x_1, x_0$)を、それぞれが発生する確率($Pr(x_1), Pr(x_0)$) で加重平均をとっている

この時、購入金額200円に対して、期待金額が59円と小さいので、長期的にはこの宝くじを購入しない方がよい

### 平均処置効果(ATE)

$$
\begin{equation}
\tau_{ATE} := E[Y_i(1) - Y_i(0)] = E[Y_i(1)] - E[Y_i(0)]
    \tag{2.4}
\end{equation}
$$

表2.2 の例でいうと、$\tau_{ATE}$ は、潜在的結果1 から潜在的結果0 の値を引いて、平均した値のこと 表2.2 では、潜在的結果1, 0 の両方とも観測できたとした（神様の立場でのデータ観測ができている）ものなので、 潜在的結果1 の平均点83.85 から 潜在的結果0 の平均点73.8 を引いた 10.05 が平均処置効果(ATE)であると言える

```{r}
mean(y1t - y0t)
mean(y1t)
mean(y0t)
mean(y1t) - mean(y0t)
```

つまり、数学の授業の補習授業には、平均して数学の試験を約10点上げる因果効果がある、と結論づけられる

ただ、何度も触れるが、潜在結果変数0, 1 は、観測できないため、この方法で計算（推定）することはできない 実は、個体処置効果(ITE) とは異なり、工夫することで平均処置効果(ATE) を推定することができる

工夫とは、処置がどのように割り付けられるかという情報を使うこと（詳細は、2.7節にて）

表2.2 の例を用いて、真の潜在的結果変数の期待値の差(真のATE/一般には計算ができない)、前後比較の平均値の差、観測された期末試験1と観測された期末試験0の平均の差 を計算してみる

```{r}
mean(y1t) - mean(y0t)  # 真の潜在的結果変数の期待値の差
mean(y3) - mean(x1)    # 前後比較の平均値の差
m1 <- mean(y1, na.rm=TRUE)  # 欠測のNAを除いて平均
m0 <- mean(y0, na.rm=TRUE)  # 欠測のNAを除いて平均
m1 - m0                # 観測された期末試験1,0の平均値の差
```

前後比較でも、観測された期末試験1,0の平均の差（推定）は、どちらも正しく推定できていないと言える

また、欠測値を除いて平均を求めるようなナイーブな欠測値を含む系列の平均値の推定は、データ欠測の文献でペアワイズ除去(pairwise deletion) として紹介されているが、適切な分析方法ではない

※ 欠測値の適切な処理方法は、19章、20章参照とのこと

------------------------------------------------------------------------

# 2.5 処置効果３：処置群の平均処置効果

母集団の一部分に対する処置効果を推定対象とすることもある e.g. 心理学では、ある種の行動をとったことが、行動をとった者にどのような影響をしたか e.g. ある政策をとった場合に、その政策に割り付けられた者にどれぐらい影響があったか

これらの効果は、処置群の平均処置効果(ATT: Average Treatment effect on the Treated) と呼ばれ、以下の式で定義される

$$
\begin{equation}
\tau_{ATT} := E[Y_i(1) - Y_i(0) | T_i=1] = E[Y_i(1) | T_i=1] - E[Y_i(0) | T_i=1]
    \tag{2.5}
\end{equation}
$$

(再掲)

```{r 表2.2(再掲)}
table_2.2()
```

表2.2 の例では、処置t1が1 の学生は、6人 (ID=1, 3, 6, 10, 13, 14 の学生)

```{r}
row.names(D)[t1==1]
length(t1[t1==1])
```

潜在結果変数0, 1 が観測できたとして整理すると、 この6人の潜在的結果0 の平均点は、64.5 この6人の潜在的結果1 の平均点は、73.83 処置群の平均処置効果(ATT)は、9.3 (= 6人の潜在的結果1-潜在的結果0 = 73.83 - 64.5)

真のATT

```{r}
mt1 <- mean(y1t[t1==1])
mt0 <- mean(y0t[t1==1])
mt1
mt0
mt1 - mt0
```

ここで、処置が無作為に割り付けられている場合、平均処置効果(ATE)と処置群の平均処置効果(ATT)が一致する

処置の割り付けが無作為でない場合、 個体処置効果$\tau_i = Y_i(1) - Y_i(0)$ が、母集団全体で異なっているなら、 ATEとATTは、異なる値となる可能性がある

特に人間の行動を観察する研究に置いては、ATEとATTは、異なる場合が多いとされている 研究テーマによって、ATE、ATT のどちらを推定するのかを決める必要がある また、統計的因果推論に用いる手法に応じて、ATE、ATT のどちらを推定できるか、が異なる （この章では、具体的な手法については触れない様子）

-   ATE、ATT が一般的な推定対象
-   ATE、ATT 以外にも、因果効果を測る推定対象はある

------------------------------------------------------------------------

# 2.6 交絡因子

2.4節における表2.2 を用いた、数学の試験に対する補習授業を受ける処置の、平均処置効果(ATE)は 10.05 であった つまり、補習授業は、平均して10.05点 改善させたと言えていた

一方で、ナイーブな推定値によると、処置は、平均して-3.95点の効果としていたが、直感的におかしい分析結果

補習授業は、学生の数学の能力を改善し、結果として数学の試験の点数も改善することが期待されている

このような「直感に反する結果」が得られたのは、ナイーブな推定量には何らかの変数による交絡(confounding) が起きている、と考えられる

表2.1 において、処置は「入学試験の点数」に応じて確定的に決定されていた（割り付けられていた） つまり、この「入学試験の点数」が交絡変数である

-   入学試験の点数が高い人は、補習授業を受けていない
-   入学試験の点数が低い人は、補習授業を受けている
-   以上から、入学時点においては、補習授業を受ける集団は、受けない集団より数学力が低い集団である
-   つまり、補習授業にプラスの効果があっても、スタート時点における数学力の差がある
    -   言い換えると、補習授業の効果が低く見積もられ、ナイーブな推定値がナイナスになったと言える

このように、統計的因果推論では、処置の割付けがどのように行われているか、が非常に重要

## 2.6.1 インフルエンザと新薬Xの関係における交絡

あるインフルエンザの患者Aが新薬Xを飲んだところ、翌日には治ったとする 新薬X は、インフルエンザに対して効果があるだろうか？

これまで、補足してきたように、「因果推論の根本問題」のため、個体処置効果(ITE) は観測されない つまり、患者A に、新薬X をのませつつ、新薬X を飲ませない、ということはできないからである

ここで、以下の条件下で考える

-   100人のインフルエンザ患者の中で、50人は新薬X を飲んでおり、50人は新薬X を飲んでいない
-   新薬X を飲んだ集団では、80% の人が翌日には治った
-   新薬X を飲まなかった集団では、20% の人が翌日には治った

この時、新薬X には、平均してインフルエンザに対して効果があると言えるだろうか？ これは、平均処置効果(ATE) ($mean(y1t) - mean(y0t)$) ではなく、ナイーブな推定量であることに注意する 性別、年齢、生活習慣、その他の要因によって、インフルエンザが治りやすい傾向の人と治りにくい傾向の人がいる、という点に注意が必要である、ということである

-   例
    -   処置群（新薬X を飲ませる群）：年齢が40歳未満、かつ、1日当たりの歩数が1万歩を超える人
    -   統制群（新薬X を飲ませない群）：年齢が40歳以上、かつ、1日当たりの歩数が1万歩以下の人
    -   処置群である新薬X を飲ませた群は、年齢が比較的若く、日頃から運動習慣がある人たちの集団になっている
    -   つまり、処置群は、体力がある集団
    -   よって、インフルエンザが治りやすい結果になった可能性がある
    -   **この処置群では、そもそも新薬X を飲まなくても治る可能性が高かったかもしれない**
    -   この処置の割り付けに対して、年齢と生活習慣という変数による交絡がある、と考えられる
    -   注意：実際は、このように人が意識的に割り付けた場合は論外だが、よくよく調べると無意識の偏り、恣意性に気づくこともある

## 2.6.2 方向付き非巡回グラフ（DAG）

方向付き非巡回グラフ (DAG: Directed Acyclic Graph)で、視覚的にみていこう

DAG は、ダグと読む 方向を持つ矢印で構成され、ループを持たないグラフ構造である

$X \rightarrow Y$ は、X が原因で Yが結果である この矢印は、因果関係を表すこともあれば、単なる回帰関係（一方向だが、因果とは限らない関係）のこともあるので注意が必要

矢印で繋がっていなければ、２つの変数は独立である（関係がない）ことを意味する

-   $Y$：期末試験の点数
-   $X_1$：補習授業（を受ける）
-   $X_2$：入学試験の点数

図2.1

```{r 図2.1, warning=FALSE}
library(DiagrammeR)

grViz("
	digraph causal_graph_2_1 {
	
	  # Nodes
	  node [shape=plaintext, fontname=Helvetica]
	  X2 [label=<X<sub>2</sub>>]
	  X1 [label=<X<sub>1</sub>>]
	  Y [label='Y']
	  
	  X22 [label=<X<sub>2</sub>>]
	  X12 [label=<X<sub>1</sub>>]
	  Y2 [label='Y']
	  
	  # Edges
	  edge [color=black, arrowhead=vee]
	  rankdir = TB
	  X2 -> X1
	  X2 -> Y
	  X1 -> Y

	  X22 -> Y2
	  X12 -> Y2

  	{rank=same; X2; X22}
	  {rank=same; X1; Y; X12; Y2}

	  # Graph
	  graph [overlap=true, fontsize=10]
	}")


```

上記 図2.1 の左のグラフ図において、$X_2 \rightarrow X1, X_2 \rightarrow Y$ のように、$X_2$ が$X_1, Y$ に影響を及ぼしている このような $X_2$ が、交絡因子(confounding factor)である このような $X_2$ が背後から影響を及ぼしている限り、$X_1$ から $Y$ への因果効果を適切に評価できない $X_2 \rightarrow X_1 \rightarrow Y$ という関係があるので、$X_1$ から $Y$ への因果効果の中には、$X_1$ を通じて影響している$X_2$ の効果も含まれている

そこで、右のグラフ図のように、$X_2 \rightarrow X_1$ の関係を断ち切ることが理想である

平均処置効果(ATE) を適切に推定するためには、2つの「比較可能な集団」を作る必要がある

-   「比較可能な集団」：原因$X$ と 結果$Y$ だけが異なり、他はほぼ同じ集団
-   インフルエンザの例
    -   100人のインフルエンザ患者を50人ずつに分ける条件
    -   男女比、平均身長、平均体重、平均年齢、１日の平均歩数、などが２つの集団の間で同じとき、「比較可能な集団」
-   「比較可能」
    -   これらの条件が同じであれば、本当に「比較可能」かどうかは疑問が残る
    -   観測されるデータについては、同質な集団に分けることができた
    -   一方で、観測されない（されていない）データに対しても２つの集団が同質なのかは、疑問ということである
    -   性別、身長、体重、年齢、歩数を同質にわけても、まだ意識したり観測していない第6、第7、・・・の（無数の）変数があるかもしれないということ

以上から、観測されない変数の影響力を意図的に統制することは、かなり難しいとわかる

------------------------------------------------------------------------

# 2.7 無作為抽出と無作為割付け

-   Q. 観測されない交絡を統制するにはどうするべきか？

-   A. 無作為割付けをすれば良い

-   無作為抽出法(random sampling)

    -   「無作為割付け」と似ているが、異なる概念

-   単純無作為抽出法(simple random sampling)

    -   母集団から標本を規則性なく選んでくること
    -   目的は、標本が母集団を代表できるようにしたい
    -   標本と母集団は、大きさだけが異なり、それ以外の要素についてはすべて平均的に似ている集団にしたい
    -   単純無作為抽出法では、母集団と標本が似ていることを「確率的に保証」している
        -   「確率的に保証」：標本抽出誤差を標準誤差により数値評価できること

※ その他の抽出法は、[こちら](https://bellcurve.jp/statistics/course/8007.html)を参照されたい

図2.2

```{r 図2.2, warning=FALSE}
library(DiagrammeR)

grViz("
	digraph random_sampling_graph_2_2 {
	
	  # Nodes
	  node [shape=oval, fontname=Helvetica]
	  P [label='母集団']
	  S [label='標本']

	  # Edges
	  edge [color=black, fontname=Helvetica, fontsize=4, arrowhead=vee]
	  rankdir = TB
	  P -> S [label='無作為抽出']
	  S -> P [label='似ているので推定可能']

	  # Graph
	  graph [overlap=true, fontsize=10]
	}")


```

図2.3

```{r 図2.3, warning=FALSE}
library(DiagrammeR)

grViz("
	digraph random_assignment_graph_2_3 {
	
	  # Nodes
	  node [shape=oval, fontname=Helvetica]
	  S [label='標本']
	  T [label='処置群']
	  C [label='統制群']

	  # Edges
	  edge [color=black, fontname=Helvetica, fontsize=10, arrowhead=vee]
	  rankdir = TB
	  S -> T [label='無作為割付け']
	  S -> C 
	  T -> C [label='似ているので比較可能', color=white, arrowhead=none]

  	{rank=same; T; C}

	  # Graph
	  graph [overlap=true, fontsize=10]
	}")


```

-   実験研究：処置群と統制群に無作為割り付けする研究
-   観察研究：処置群と統制群に無作為割り付けしない研究

------------------------------------------------------------------------

# 2.8 無作為割付けによる分析の例

表2.1、表2.2 の例では、処置の割付けが入学試験の点数に依存していた

ここで処置の割付けが無作為に行われた状況を考える 具体的には、以下のように無作為割付けを行う

```{r 無作為割付け}
set.seed(1)
r0 <- runif(20, 0, 1) # [0, 1]区間から一様乱数を20個サンプリング
r0
r1 <- round(r0, 0) # 四捨五入
r1

# 本来は、観測できない潜在結果変数(y1t, y0t)を使って割付け
y2 <- NULL
y2[r1==1] <- y1t[r1==1]   # 処置群
y2[r1==0] <- y0t[r1==0]   # 統制群
y2
```

以上により、y2 は、処置が無作為割付けされた結果の期末試験の点数になっている

次に、平均処置効果(ATE) を推定する

```{r 平均処置効果(ATE) の推定}
mr1 <- mean(y2[r1==1])
mr0 <- mean(y2[r1==0])
mr1
mr0
mr1 - mr0
```

平均処置効果(ATE) は、12.5 として推定される これまでの推定値の中で最も近い値を推定できていると言える 標本サイズがもっと大きければ、より正確な結果を期待できる

この無作為割付けは、コインの表裏で処置群、統制群を割り付けていると解釈できる コインの裏表は、性別、身長、体重、年齢、生活習慣のいずれとも無関係 観測されていない第６、７・・・の変数に対しても無関係

つまり、無作為割付けに基づく実験研究では、すべての交絡を調整することが可能とみなせる

実験研究は、因果推論のゴールドスタンダードとして知られている

処置が行われた場合、ある個体$i$の結果変数の値が確率的に変動するように思える 統計的因果推論では、潜在的結果変数の値は、個体ごとに決まっていると考える 確率的に決まるのは、ある個体が処置群に割付けられるか、統制群に割付けられるかの方

表2.2 の例では、潜在的結果変数0, 1 は、個体ごとに定まった値であった これらの組のうち、どちらかが観測され期末試験0, 1 の値が観測されるか、欠測されるかが決まる、と考える 期末試験0, 1 のどちらとして観測されるかが確率的に決まるということ

------------------------------------------------------------------------

# 2.9 内的妥当性と外的妥当性

-   2種類の妥当性(validity)
    -   内的妥当性(internal validity)
        -   A と B の関連が観察されたとき、A から B への因果的な関係を反映しているかどうか
        -   「実験研究」は、この目的のために行われる
    -   外的妥当性(external validity)
        -   人々、状況、処置、結果におけるさまざまな変動のある条件下で、因果関係がどの程度まで成立するか
        -   研究成果がどれだけ一般化できるか、という意味の妥当性
        -   母集団から無作為抽出された標本に基づく「観察研究」は、この目的のために行われる

------------------------------------------------------------------------

# 2.10 2標本t検定

ここでは、無作為割付けをしたデータを使って、t検定の解析結果をみる

```{r 表2.9 2標本t検定}
t.test(y2[r1==1], y2[r1==0], var.equal=FALSE)  # 等分散性は、仮定できないので FALSE
```

    95 percent confidence interval:
      4.219264 20.811039

95%信頼区間(95% confidence interval) は、4.219 〜 20.811 で、0 が含まれていないことから、2つの集団（処置群と統制群）の差は、5% 水準で有意

2.2節の最後により、このデータにおける変数 y0t は、$0.9x_{1i} + \varepsilon_i$ で生成され、 y1t は、$10 + 0.9x_{1i} + \varepsilon_i$ として生成されているため、 母集団における ATE は、10 であり、実際にこの値は、95% 信頼区間に含まれている

（参考）

```{r 潜在的結果変数}
y1t  # 潜在的結果変数1
y0t  # 潜在的結果変数0
```
