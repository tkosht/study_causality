---
title: "Chapter4 潜在的結果変数の枠組み"
author: "Takehito Oshita"
output: 
  slidy_presentation:
    font_adjustment: -1
---

本章で使うデータを読み込んでおきます

```{r データ読み込み, warning=FALSE}
library(tibble)
library(knitr)
library(kableExtra)

rm(list=ls())

load_data <- function(){
  url.data.file <- "https://raw.githubusercontent.com/mtakahashi123/causality/main/data04.csv"
  D <- read.csv(url(url.data.file))
  return(D)  
}

D <- load_data()

tabular <- function(df, color=F, title="表"){
    df %>%
    rownames_to_column(var="ID") %>%
    kable(caption=title) %>%
    kable_styling(fixed_thead=T, bootstrap_options=c("striped", "hover", "condensed"))
}

tabular(D)
```

------------------------------------------------------------------------

# 4.1 標準誤差

定義

$$
s.e.(\bar{X}) := \frac{\sigma}{\sqrt{n}}
$$

## 4.1.1 母集団データ

-   母数
    -   母集団分布を決定する定数
    -   e.g. 母平均、母標準偏差

母平均 $\mu$

$$
\mu := \frac{1}{N} \sum_{i=1}^{N} X_i \tag{4.2}
$$

母標準偏差 $\sigma$ ／ 母分散 $\sigma^2$

$$
\sigma := \sqrt{\frac{1}{N} \sum_{i=1}^{N} (X_i - \mu)^2} \tag{4.2}
$$

表4.1

| 人名 | 身長(cm) |
|:----:|:--------:|
|  A   |   165    |
|  B   |   166    |
|  C   |   171    |
|  D   |   180    |

```{r}
x1 <- c(165, 166, 171, 180)
N1 <- length(x1)
n1 <- 2

mu <- mean(x1)
deviation <- x1 - mu
deviation2 <- deviation^2
sigma2 <- sum(deviation2) / N1
sigma <- sqrt(sigma2)

```

```{r}
mu
sigma
```

------------------------------------------------------------------------

## 4.1.2 標本抽出と標本平均

N1=4 の母集団データから n1=2 のサイズの標本を選ぶ方法は、$_4C_2 = 6$ 通り

```{r}
choose(4, 2)
```

表4.3 標本サイズ2のすべての標本

|  標本1   |  標本2   |  標本3   |  標本4   |  標本5   |  標本6   |
|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|
| A(165cm) | A(165cm) | A(165cm) | B(166cm) | B(166cm) | C(171cm) |
| B(166cm) | C(171cm) | D(180cm) | C(171cm) | D(180cm) | D(180cm) |

```{r}
table4.3 <- function(){
  df <- data.frame(combn(x1, n1))
  colnames(df) <- c("標本1", "標本2", "標本3", "標本4", "標本5", "標本6")
  tabular(df, title="表4.3")
}

table4.3()
```

```{r}
xs <- combn(x1, n1)
xbars <- apply(xs, 2, mean)
mean(xbars)   # == mu
mu

dev.b <- xbars - mu
dev.b2 <- dev.b^2

sigma.b2 <- mean(dev.b2)
sigma.b <- sqrt(sigma.b2)

```

```{r}
xs
```

```{r}
xbars
```

```{r}
mean(xbars)

sigma.b
```

$$
E[\bar{X}] = E[\frac{1}{n} \sum_{i=1}^{n} X_i] = \frac{1}{n} \sum_{i=1}^{n} E[X_i] = \frac{1}{n} \sum_{i=1}^{n} \mu = \frac{1}{n} n \mu = \mu
$$

-   不偏性
    -   推定量の期待値が、母数に一致する性質
    -   e.g. 標本平均は、母平均の不偏推定量
    -   一方で、推定量の期待値が、母数に一致しない場合、その推定量には偏り(bias)がある、という

------------------------------------------------------------------------

## 4.1.3 標本平均のばらつき

標本平均の標準偏差

$w = 1, 2, ..., W$ は、標本抽出の回数、$W$ は、標本数 標本平均の標準偏差 $sd(\bar{X}_{W})$ は、標本平均 $\bar{X}_w$ と真の母平均 $\mu$ との典型的な距離を表す

$$
\text{sd}(\bar{X}_{W}) := \sqrt{\frac{1}{W} \sum_{w=1}^{W} (\bar{X}_w - \mu)^2}
\tag{4.5}
$$ 標本平均の分散は、$\frac{\sigma^2}{n}$ (理論的に導出される)

以下、無限母集団の場合の標本平均の分散

$\{X_i\}_i$ が、iid （独立同分布）の時（i.e. $cov[X_i, X_j] = 0, (i \neq j)$）

\$\$ \text{var}[\bar{X}] = \text{var}[\frac{1}{n} \sum\_{i=1}\^{n} X_i] = \frac{1}{n^2} \sum\_{i=1}\^{n} \text{var}[X_i] = \frac{1}{n^2} n \sigma\^2 = \frac{\sigma^2}{n}

\$\$ 有限母集団では、修正項 $\sqrt{\frac{N-n}{N-1}}$ を乗じて、以下で求める

$$
\frac{\sigma}{\sqrt{n}} \sqrt{\frac{N-n}{N-1}}
$$

表4.3 の例で計算

$\sigma = 5.94, N = 4, n = 2$

```{r}
N = 4
n = 2
sgm <- sqrt(mean((xs - mu)^2))
sgm

sgm / sqrt(n)
```

$$
\frac{\sigma}{\sqrt{n}} \sqrt{\frac{N-n}{N-1}} = \frac{5.94^2}{\sqrt(2)} \sqrt{\frac{4-2}{4-1}}
$$

```{r}
sgm / sqrt(n) * sqrt((N-n)/(N-1))   # sigma.b と一致する
sigma.b
```

-   標準誤差
    -   標本統計量が母数から典型的にどれぐらい離れているか
    -   不確実性を表す
    -   標準誤差が小さいほど、推定精度が高いことを意味する

```{r}
sigma   # 母集団の標準偏差

se0 <- sigma / sqrt(n1)   # 無限母集団の標本平均の標準偏差
adj <- sqrt((N1 - n1)/(N1 - 1))
se1 <- se0 * adj          # 有限母集団の標本平均の標準偏差（母集団サイズN1, 標本サイズn1）

se0
se1
```

------------------------------------------------------------------------

## 4.1.4 中心極限定理

-   中心極限定理（central limit theorem）
    -   平均$\mu$ と 分散$\sigma^2$ の母集団から、標本サイズ$n$の標本が無作為に抽出されるとき
    -   母集団の分布形状にかかわらず、標本平均は、平均$\mu$ 分散$\sigma^2/n$ の正規分布に近似的に従う
-   標本平均 $\bar{X}$ を標準化した$Z$ は、標準正規分布 $N(0, 1)$に近似的に従う

$$
\begin{align}
Z &:= \frac{\bar{X} - E[\bar{X}]}{\text{sd}(\bar{X})} \\
  & = \frac{\bar{X} - \mu}{\sigma / n} \\
\tag{4.9}
\end{align}
$$ ※ $n$ : 標本サイズ

$3\sigma$ ルール 以下のように、$\sigma$ の範囲での確率を、正規分布とみなして近似すること

$$
\Pr(\mu - 1 \sigma \leq X \leq \mu + 1 \sigma) \approx 68.27% \\
\Pr(\mu - 2 \sigma \leq X \leq \mu + 2 \sigma) \approx 95.45% \\
\Pr(\mu - 3 \sigma \leq X \leq \mu + 3 \sigma) \approx 99.73% \\
$$

------------------------------------------------------------------------

## 4.1.5 t統計量

以降は、標本数が 1 のケースを考える

これまで、母平均 $\mu$ が未知、母標準偏差 $\sigma$ が既知である条件で話を進めてきた

しかし、通常、母平均 $\mu$ が未知なら、母標準偏差 $\sigma$ も未知である

そこで、母標準偏差 $\sigma$ の代わりになる推定値が必要になる

手元にあるデータが母集団なら、$\mu$ と $\sigma$ を推定する必要はなく、データから直接計算すればよい(つまり、$\mu$ と $\sigma$ が既知)

多くの場合、手元にあるデータが標本であり、$\mu$ と $\sigma$ が未知

分散と標準偏差の式には、平均値が含まれている。つまり、分散と標準偏差を推定する前に平均値を知っていなければならない、ということである

そこで、標準平均を使って母平均を推定する。

-   推定を $k$ 回行うと、自由度(df: degrees of freedom) は、$k$ 個減る
    -   i.e. $k$ : 推定する母数の数
-   標本データから分散や標準偏差を計算する際には、分母は $n$ ではなく、$n-1$

不偏分散 $s^2$

$$
s^2 = \frac{1}{n-1} \sum_{i=1}^{n} (X_i - \hat{X})^2
\tag{4.10}
$$

不偏標準偏差 $s$

$$
s = \sqrt{\frac{1}{n-1} \sum_{i=1}^{n} (X_i - \hat{X})^2}
\tag{4.11}
$$

標準誤差として、$\sigma / \sqrt{n}$ は計算不可能。なので、代わりに $s / \sqrt{n}$ を用いる

-   $s / \sqrt{n}$ : 母数を推定する標本統計量の標準偏差の推定値

式(4.9) の $Z$ の右辺の $\sigma$ を $s$ に変えたものを、「t統計量」という

つまり、

$$
\begin{align}
t &:= \frac{\bar{X} - \mu}{s / n} \\
\tag{4.12}
\end{align}
$$ このt統計量$t$ は、自由度$n-1$ の t分布に従う t分布は、小標本の厳密な標本分布（sampling distribution）

標本サイズ 80、推定すべき母数が 1個、95%の信頼係数の算出例(2つとも同じ結果)

```{r}
qt(0.025, 80-1, lower.tail=FALSE)
# qt(0.025, 80-1)
qt(0.975, 80-1)
```

------------------------------------------------------------------------

# 4.2 信頼区間

-   点推定値（point estimate）
    -   母数（パラメータ）を推定するために使われる統計量の値そのもの
    -   e.g. 標本平均 $\bar{X}$ は、母平均 $\mu$ の点推定
    -   標本抽出誤差があるので、標本平均が母平均と完全に一致すると考えることは合理的ではない
    -   一般論として、標本統計量が母数に一致することはほとんどないと考えよう
-   区間推定値（interval estimate）
    -   推定値のまわりに誤差を加味した区間を構成する
    -   真の母数の値が入る確率が、ある値以上と保証される区間を求めること
-   信頼区間（CI: Confidence Interval）
    -   標本を何度も抽出した時、無数にある区間のうち、ある確率で真の母数が含まれる区間
    -   ある１つの信頼区間の中に母数が含まれる確率は、0%または100%であることに注意する

------------------------------------------------------------------------

## 4.2.1 90%信頼区間の例

-   90%信頼区間
    -   標本を何度も抽出した時、無数にある信頼区間のうち90%の中に真の母数が含まれる区間
    -   ある１つの90%信頼区間の中に母数が含まれる確率は90%ではなく、0%または100%である
-   例
    -   日本人成人男性の身長の平均：171cm
    -   日本人成人男性：母集団
        -   1000人を無作為に抽出し、この標本抽出を20回
        -   i.e. 標本サイズ：1000, 標本数：20
-   標本平均の信頼区間
    -   $\bar{X}$ : 標本平均
    -   $s$ : 標本標準偏差
    -   $n$ : 標本サイズ
    -   $t_{\alpha}(df)$ : t分布に基づく信頼係数

$$
\bar{X} \pm t_{\alpha}(df) \times \frac{s}{\sqrt{n}}
\tag{4.13}
$$

------------------------------------------------------------------------

## 4.2.2 信頼区間によるt検定

検定のステップ

1.  帰無仮説(null hypothesis)と対立仮説(alternative hypothesis) を設定する

    -   $H_0$ : 帰無仮説、$H_A$ : 対立仮説
    -   ここでは、$H_0$ : $\mu_0 = 255$、$H_A$ : $\mu_0 \neq 255$ とする
    -   今回は、両側検定

2.  有意水準を決める

    -   ここでは、5% とする ($2 \alpha = 0.05, \alpha = 0.025$)

3.  データから標本平均と標本標準偏差を計算する

    -   標本平均$\bar{X} = 250$、標本標準偏差 $s = 6$ とわかったとする
    -   ここで、標本サイズ$n = 50 (df=49)$

4.  以下の式(4.14) を用いて、信頼区間を計算する。(qt 関数を使い、$t_{0.025}(49) = 2.01$ と算出)

```{r}
t <- qt(0.025, 49, lower.tail=FALSE)
t
round(t, 2)
```

$$
\bar{X} \pm t_{\alpha}(df) \times \frac{s}{\sqrt{n}} = 250 \pm 2.01 \times \frac{6}{\sqrt{50}}
= \text{CI}_{95\%} (248.3, 251.7)
\tag{4.14}
$$

5. ステップ4 で計算した信頼区間の中に、帰無仮説$H_0$ の値が入っているかどうかを確認
  - 帰無仮説を棄却できるかどうかを判断
  - 信頼区間が $248.3 \sim 251.7$、帰無仮説が主張している値 $255$
    - 信頼区間内に入っていないので、5% 有意水準で帰無仮説を棄却できる


---

## 4.2.3 信頼区間による対応のある場合の２標本t検定


- 2標本t検定
  - 各個体に対して、ペアとなる観測値が観測されている場合に使う
  - e.g. 潜在的結果変数1と潜在的結果変数0
  - ペアの差（潜在的結果変数1 - 潜在的結果変数0）を使って、1標本t検定を行う


```{r}
rm(x1, n1, N1)
attach(D)
summary(D)
```



```{r}
n1 <- nrow(D)
n1

delta1 <- y1t - y0t
delta1

m1 <- mean(delta1)
s1 <- sd(delta1)
m1
s1

cat("--------------------------------------------------------------------------------", "\n")
t.alpha <- qt(0.025, n1-1, lower.tail=FALSE)
t.alpha

cat("--------------------------------------------------------------------------------", "\n")
m1 - t.alpha * s1 / sqrt(n1)
m1 + t.alpha * s1 / sqrt(n1)

cat("--------------------------------------------------------------------------------", "\n")
t.test(delta1)
```

95% 信頼区間が、0 を含んでいないので、5%有意水準で、母集団においても効果ありと判断できる


---

## 4.2.4 信頼区間による対応のない２標本t検定


- 対応のない２標本t検定
  - 同じ個体に対して、数字がペアで利用できない時に用いる
  - ２つの標本間で母分散が等しいか等しくないかによって、使うべき手法が異なるとされている
  - 等分散の検定
    - 母分散が等しい場合の検定
  - Welch の検定
    - 母分散が等しくない場合の検定


- 母分散は未知
  - 標本データだけからでは、母分散が等しいかどうか判断することができない
  - 母分散の検定を行ってから、t検定を行うこともできる
    - このような２段階の検定は、多重検定の問題が発生する

- 母分散が等しくないのに、等分散の検定を行うと
  - 第１種の過誤の確率が非常に大きくなってしまう
- 母分散が等しいのに、Welch の検定を行うと
  - 第２種の過誤の確率がわずかに大きくなる（だけ）
- 本書では、Welch の検定を用いる


- 定義
  - $Y_{0}^{obs}$ : 期末試験0
  - $Y_{1}^{obs}$ : 期末試験1
  - $\bar{Y}_{1}^{obs} - \bar{Y}_{0}^{obs}$ : 知りたい効果
  - $s_0^2$ : $Y_{0}^{obs}$ の不偏分散
  - $s_1^2$ : $Y_{1}^{obs}$ の不偏分散
  - $n_0$ : $Y_{0}^{obs}$ の標本サイズ
  - $n_1$ : $Y_{1}^{obs}$ の標本サイズ

$$
s.e.(\bar{Y}_{1}^{obs} - \bar{Y}_{0}^{obs}) = \sqrt{\frac{s_0^2}{n_0} + \frac{s_1^2}{n_1}}
\tag{4.15}
$$

Welch の検定での自由度の計算（複雑）

$$
df := \frac{(s_1^2/n_1 + s_0^2/n_0)^2}{\frac{(s_1^2/n_1)^2}{n_1 - 1} + \frac{(s_0^2/n_0)^2}{n_0 - 1}}
$$

対応のない２標本t検定（Welch の検定）

```{r}
y0
y0.obs <- na.omit(y0)
y0.obs

y1
y1.obs <- na.omit(y1)
y1.obs


n0 <- length(y0.obs)
n1 <- length(y1.obs)
n0
n1

s0 <- sd(y0.obs)
s1 <- sd(y1.obs)
s0
s1

nm <- (s1^2/n1 + s0^2/n0)^2
dnm <- ( (s1^2/n1)^2/(n1-1) + (s0^2/n0)^2/(n0-1) )
df1 <- nm / dnm
df1

xbar <- mean(y1.obs) - mean(y0.obs)
xbar

se1 <- sqrt(s1^2/n1 + s0^2/n0)
se1

cat("--------------------------------------------------------------------------------", "\n")
t.alpha <- qt(0.025, df1, lower.tail=FALSE)
t.alpha

cat("--------------------------------------------------------------------------------", "\n")
xbar - t.alpha * se1
xbar + t.alpha * se1

cat("--------------------------------------------------------------------------------", "\n")
t.test(y1.obs, y0.obs, var.equal=FALSE)

```

- 95%信頼区間は、0 を含んでいないため、5%有意水準で母集団において効果ありと判断できる
  - ただし、標本サイズが非常に小さいため、不確実性が高く信頼区間の幅がとても大きい


```{r}
84.08333 - 73.12500   # xbar と一致
xbar
```



